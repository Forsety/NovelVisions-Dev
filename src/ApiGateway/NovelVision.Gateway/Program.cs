// src/ApiGateway/NovelVision.Gateway/Program.cs

using System.Text;
using AspNetCoreRateLimit;
using CacheManager.Core;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.AspNetCore.Diagnostics.HealthChecks;
using Microsoft.Extensions.Diagnostics.HealthChecks;
using Microsoft.IdentityModel.Tokens;
using Microsoft.OpenApi.Models;
using Ocelot.Cache.CacheManager;
using Ocelot.DependencyInjection;
using Ocelot.Middleware;
using Ocelot.Provider.Polly;
using Serilog;
using Serilog.Events;

// ???????????????????????????????????????????????????????????????????????????
// Configure Serilog
// ???????????????????????????????????????????????????????????????????????????
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Debug()
    .MinimumLevel.Override("Microsoft", LogEventLevel.Information)
    .MinimumLevel.Override("Ocelot", LogEventLevel.Debug)
    .Enrich.FromLogContext()
    .WriteTo.Console()
    .WriteTo.File("logs/gateway-.txt", rollingInterval: RollingInterval.Day)
    .CreateBootstrapLogger();

try
{
    Log.Information("Starting NovelVision API Gateway");

    var builder = WebApplication.CreateBuilder(args);

    // ???????????????????????????????????????????????????????????????????????????
    // Configure Serilog Host
    // ???????????????????????????????????????????????????????????????????????????
    builder.Host.UseSerilog((context, services, configuration) => configuration
        .ReadFrom.Configuration(context.Configuration)
        .ReadFrom.Services(services)
        .Enrich.WithProperty("ServiceName", "NovelVision.Gateway")
        .Enrich.WithProperty("Environment", context.HostingEnvironment.EnvironmentName));

    // ???????????????????????????????????????????????????????????????????????????
    // Load Ocelot configuration
    // ???????????????????????????????????????????????????????????????????????????
    builder.Configuration
        .SetBasePath(builder.Environment.ContentRootPath)
        .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
        .AddJsonFile($"appsettings.{builder.Environment.EnvironmentName}.json", optional: true)
        .AddJsonFile("ocelot.json", optional: false, reloadOnChange: true)
        .AddJsonFile($"ocelot.{builder.Environment.EnvironmentName}.json", optional: true)
        .AddEnvironmentVariables();

    ConfigureServices(builder.Services, builder.Configuration, builder.Environment);

    var app = builder.Build();

    await ConfigureAsync(app, app.Environment, app.Configuration);

    await app.RunAsync();
}
catch (Exception ex)
{
    Log.Fatal(ex, "Gateway terminated unexpectedly");
}
finally
{
    Log.CloseAndFlush();
}

// ???????????????????????????????????????????????????????????????????????????
// Service Configuration
// ???????????????????????????????????????????????????????????????????????????
static void ConfigureServices(IServiceCollection services, IConfiguration configuration, IWebHostEnvironment environment)
{
    // Add HttpContextAccessor first
    services.AddHttpContextAccessor();

    // ???????????????????????????????????????????????????????????????????????
    // CORS Configuration
    // ???????????????????????????????????????????????????????????????????????
    services.AddCors(options =>
    {
        options.AddPolicy("GatewayPolicy", policy =>
        {
            var allowedOrigins = configuration.GetSection("Cors:AllowedOrigins").Get<string[]>()
                ?? new[] { "http://localhost:3000", "https://localhost:3000" };

            policy.WithOrigins(allowedOrigins)
                  .AllowAnyMethod()
                  .AllowAnyHeader()
                  .AllowCredentials()
                  .SetPreflightMaxAge(TimeSpan.FromSeconds(3600))
                  .WithExposedHeaders("Token-Expired", "X-Request-Id", "X-Total-Count");
        });
    });

    // ???????????????????????????????????????????????????????????????????????
    // Authentication Configuration
    // ???????????????????????????????????????????????????????????????????????
    ConfigureAuthentication(services, configuration);

    // ???????????????????????????????????????????????????????????????????????
    // Authorization Policies
    // ???????????????????????????????????????????????????????????????????????
    services.AddAuthorization(options =>
    {
        options.AddPolicy("ApiScope", policy =>
        {
            policy.RequireAuthenticatedUser();
        });

        options.AddPolicy("RequireAdminRole", policy =>
        {
            policy.RequireRole("Admin", "SuperAdmin");
        });

        options.AddPolicy("RequireAuthorRole", policy =>
        {
            policy.RequireRole("Author", "Editor", "Admin", "SuperAdmin");
        });
    });

    // ???????????????????????????????????????????????????????????????????????
    // Rate Limiting
    // ???????????????????????????????????????????????????????????????????????
    ConfigureRateLimiting(services, configuration);

    // ???????????????????????????????????????????????????????????????????????
    // Health Checks - All Services
    // ???????????????????????????????????????????????????????????????????????
    services.AddHealthChecks()
        // Gateway self-check
        .AddCheck("gateway-self", () => HealthCheckResult.Healthy("Gateway is running"),
            tags: new[] { "gateway", "live" })

        // Catalog.API Health Check
        .AddUrlGroup(
            new Uri("https://localhost:7295/health"),
            name: "catalog-api",
            failureStatus: HealthStatus.Degraded,
            tags: new[] { "catalog", "downstream", "ready" },
            timeout: TimeSpan.FromSeconds(5))

        // Visualization.API Health Check
        .AddUrlGroup(
            new Uri("https://localhost:7130/health"),
            name: "visualization-api",
            failureStatus: HealthStatus.Degraded,
            tags: new[] { "visualization", "downstream", "ready" },
            timeout: TimeSpan.FromSeconds(5))

        // PromptGen.API Health Check (Python/FastAPI)
        .AddUrlGroup(
            new Uri("http://localhost:8000/api/v1/health"),
            name: "promptgen-api",
            failureStatus: HealthStatus.Degraded,
            tags: new[] { "promptgen", "downstream", "ready" },
            timeout: TimeSpan.FromSeconds(5));

    // ???????????????????????????????????????????????????????????????????????
    // Controllers & API Documentation
    // ???????????????????????????????????????????????????????????????????????
    services.AddControllers();
    services.AddEndpointsApiExplorer();

    services.AddSwaggerGen(options =>
    {
        options.SwaggerDoc("gateway", new OpenApiInfo
        {
            Title = "NovelVision API Gateway",
            Version = "v1",
            Description = @"
# NovelVision API Gateway

Unified gateway for all NovelVision microservices.

## Available Services

| Service | Prefix | Description |
|---------|--------|-------------|
| **Catalog** | `/catalog/*` | Book & Author management |
| **Visualization** | `/visualization/*` | AI Image generation |
| **PromptGen** | `/promptgen/*` | Prompt enhancement (Python) |
| **Reading** | `/reading/*` | Public reading endpoints |
| **Auth** | `/auth/*` | Authentication |

## Service Ports (Development)

| Service | HTTP | HTTPS |
|---------|------|-------|
| Gateway | 5000 | 7000 |
| Catalog.API | 5231 | 7295 |
| Visualization.API | 5284 | 7130 |
| PromptGen.API | 8000 | - |

## Health Endpoints

- `/health` - Gateway health
- `/health/ready` - All downstream services ready
- `/health/live` - Gateway liveness
- `/catalog/health` - Catalog service health
- `/visualization/health` - Visualization service health
- `/promptgen/health` - PromptGen service health
",
            Contact = new OpenApiContact
            {
                Name = "NovelVision Team",
                Email = "support@novelvision.com",
                Url = new Uri("https://novelvision.com")
            },
            License = new OpenApiLicense
            {
                Name = "MIT",
                Url = new Uri("https://opensource.org/licenses/MIT")
            }
        });

        // JWT Authentication in Swagger
        options.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme
        {
            Description = @"JWT Authorization header using the Bearer scheme.
Enter 'Bearer' [space] and then your token in the text input below.
Example: 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'",
            Name = "Authorization",
            In = ParameterLocation.Header,
            Type = SecuritySchemeType.ApiKey,
            Scheme = "Bearer"
        });

        options.AddSecurityRequirement(new OpenApiSecurityRequirement
        {
            {
                new OpenApiSecurityScheme
                {
                    Reference = new OpenApiReference
                    {
                        Type = ReferenceType.SecurityScheme,
                        Id = "Bearer"
                    },
                    Scheme = "oauth2",
                    Name = "Bearer",
                    In = ParameterLocation.Header
                },
                new List<string>()
            }
        });

        // Include XML comments if available
        var xmlFile = $"{System.Reflection.Assembly.GetExecutingAssembly().GetName().Name}.xml";
        var xmlPath = Path.Combine(AppContext.BaseDirectory, xmlFile);
        if (File.Exists(xmlPath))
        {
            options.IncludeXmlComments(xmlPath);
        }
    });

    // ???????????????????????????????????????????????????????????????????????
    // Response Caching
    // ???????????????????????????????????????????????????????????????????????
    services.AddResponseCaching();

    // ???????????????????????????????????????????????????????????????????????
    // Ocelot with Extensions
    // ???????????????????????????????????????????????????????????????????????
    services.AddOcelot(configuration)
        .AddCacheManager(settings =>
        {
            settings.WithDictionaryHandle()
                .WithExpiration(CacheManager.Core.ExpirationMode.Absolute, TimeSpan.FromMinutes(5));
        })
        .AddPolly();

    // ???????????????????????????????????????????????????????????????????????
    // Custom Services
    // ???????????????????????????????????????????????????????????????????????
    services.AddSingleton<IConfiguration>(configuration);
}

// ???????????????????????????????????????????????????????????????????????????
// Authentication Configuration
// ???????????????????????????????????????????????????????????????????????????
static void ConfigureAuthentication(IServiceCollection services, IConfiguration configuration)
{
    var jwtSettings = configuration.GetSection("JwtSettings");
    var key = Encoding.ASCII.GetBytes(
        jwtSettings["Secret"] ?? "YourSecretKeyHere1234567890123456");

    services.AddAuthentication(options =>
    {
        options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
        options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
    })
    .AddJwtBearer("Bearer", options =>
    {
        options.RequireHttpsMetadata = false;
        options.SaveToken = true;
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuerSigningKey = true,
            IssuerSigningKey = new SymmetricSecurityKey(key),
            ValidateIssuer = true,
            ValidIssuer = jwtSettings["Issuer"] ?? "NovelVision.Gateway",
            ValidateAudience = true,
            ValidAudience = jwtSettings["Audience"] ?? "NovelVision.Client",
            ValidateLifetime = true,
            ClockSkew = TimeSpan.FromMinutes(5)
        };

        options.Events = new JwtBearerEvents
        {
            OnAuthenticationFailed = context =>
            {
                if (context.Exception.GetType() == typeof(SecurityTokenExpiredException))
                {
                    context.Response.Headers.Append("Token-Expired", "true");
                }
                Log.Warning("Authentication failed: {Error}", context.Exception.Message);
                return Task.CompletedTask;
            },
            OnTokenValidated = context =>
            {
                Log.Debug("Token validated for user: {User}",
                    context.Principal?.Identity?.Name ?? "Unknown");
                return Task.CompletedTask;
            }
        };
    });
}

// ???????????????????????????????????????????????????????????????????????????
// Rate Limiting Configuration
// ???????????????????????????????????????????????????????????????????????????
static void ConfigureRateLimiting(IServiceCollection services, IConfiguration configuration)
{
    services.AddMemoryCache();

    services.Configure<IpRateLimitOptions>(configuration.GetSection("IpRateLimiting"));
    services.Configure<ClientRateLimitOptions>(configuration.GetSection("ClientRateLimiting"));

    services.AddInMemoryRateLimiting();
    services.AddSingleton<IRateLimitConfiguration, RateLimitConfiguration>();
}

// ???????????????????????????????????????????????????????????????????????????
// Application Pipeline Configuration
// ???????????????????????????????????????????????????????????????????????????
static async Task ConfigureAsync(WebApplication app, IWebHostEnvironment env, IConfiguration configuration)
{
    // Error handling
    if (env.IsDevelopment())
    {
        app.UseDeveloperExceptionPage();
    }
    else
    {
        app.UseExceptionHandler("/error");
        app.UseHsts();
    }

    // Request pipeline
    app.UseSerilogRequestLogging(options =>
    {
        options.EnrichDiagnosticContext = (diagnosticContext, httpContext) =>
        {
            diagnosticContext.Set("RequestHost", httpContext.Request.Host.Value);
            diagnosticContext.Set("RequestScheme", httpContext.Request.Scheme);
            diagnosticContext.Set("RemoteIP", httpContext.Connection.RemoteIpAddress);
        };
    });

    app.UseHttpsRedirection();
    app.UseRouting();

    // CORS
    app.UseCors("GatewayPolicy");

    // Rate limiting
    app.UseIpRateLimiting();

    // Response caching
    app.UseResponseCaching();

    // Authentication & Authorization
    app.UseAuthentication();
    app.UseAuthorization();

    // Map controllers
    app.MapControllers();

    // Health check endpoints
    ConfigureHealthChecks(app);

    // Swagger UI
    ConfigureSwagger(app, env);

    // Custom endpoints
    ConfigureCustomEndpoints(app);

    // Initialize Ocelot
    await app.UseOcelot();

    Log.Information("???????????????????????????????????????????????????????????????");
    Log.Information("NovelVision API Gateway started successfully");
    Log.Information("???????????????????????????????????????????????????????????????");
    Log.Information($"Environment: {env.EnvironmentName}");
    Log.Information($"Base URL: {configuration["GlobalConfiguration:BaseUrl"]}");
    Log.Information("???????????????????????????????????????????????????????????????");
    Log.Information("Available Endpoints:");
    Log.Information("  Swagger UI:         https://localhost:7000/swagger");
    Log.Information("  Health Check:       https://localhost:7000/health");
    Log.Information("  Health Ready:       https://localhost:7000/health/ready");
    Log.Information("  Health Live:        https://localhost:7000/health/live");
    Log.Information("???????????????????????????????????????????????????????????????");
    Log.Information("Downstream Services:");
    Log.Information("  Catalog API:        https://localhost:7295 ? /catalog/*");
    Log.Information("  Visualization API:  https://localhost:7130 ? /visualization/*");
    Log.Information("  PromptGen API:      http://localhost:8000  ? /promptgen/*");
    Log.Information("  Reading:            https://localhost:7295 ? /reading/*");
    Log.Information("  Auth:               https://localhost:7295 ? /auth/*");
    Log.Information("???????????????????????????????????????????????????????????????");
}

// ???????????????????????????????????????????????????????????????????????????
// Health Checks Configuration
// ???????????????????????????????????????????????????????????????????????????
static void ConfigureHealthChecks(WebApplication app)
{
    // General health check (all checks)
    app.MapHealthChecks("/health", new HealthCheckOptions
    {
        ResponseWriter = HealthChecks.UI.Client.UIResponseWriter.WriteHealthCheckUIResponse
    });

    // Ready check (downstream services)
    app.MapHealthChecks("/health/ready", new HealthCheckOptions
    {
        Predicate = check => check.Tags.Contains("ready"),
        ResponseWriter = HealthChecks.UI.Client.UIResponseWriter.WriteHealthCheckUIResponse
    });

    // Live check (gateway only)
    app.MapHealthChecks("/health/live", new HealthCheckOptions
    {
        Predicate = check => check.Tags.Contains("live"),
        ResponseWriter = HealthChecks.UI.Client.UIResponseWriter.WriteHealthCheckUIResponse
    });
}

// ???????????????????????????????????????????????????????????????????????????
// Swagger Configuration
// ???????????????????????????????????????????????????????????????????????????
static void ConfigureSwagger(WebApplication app, IWebHostEnvironment env)
{
    app.UseSwagger(options =>
    {
        options.RouteTemplate = "swagger/{documentName}/swagger.json";
        options.SerializeAsV2 = false;
    });

    app.UseSwaggerUI(options =>
    {
        options.SwaggerEndpoint("/swagger/gateway/swagger.json", "Gateway API");

        // Add downstream service swagger endpoints
        options.SwaggerEndpoint("/catalog/swagger/v1/swagger.json", "Catalog API v1");
        options.SwaggerEndpoint("/visualization/swagger/v1/swagger.json", "Visualization API v1");
        options.SwaggerEndpoint("/promptgen/openapi.json", "PromptGen API (Python)");

        options.RoutePrefix = "swagger";
        options.DocumentTitle = "NovelVision API Gateway";
        options.DisplayRequestDuration();
        options.EnableDeepLinking();
        options.EnableFilter();
        options.ShowExtensions();

        // Dark theme
        options.InjectStylesheet("/swagger-ui/custom.css");
    });
}

// ???????????????????????????????????????????????????????????????????????????
// Custom Endpoints
// ???????????????????????????????????????????????????????????????????????????
static void ConfigureCustomEndpoints(WebApplication app)
{
    // Root endpoint - API info
    app.MapGet("/", () => Results.Ok(new
    {
        service = "NovelVision API Gateway",
        version = "1.0.0",
        status = "running",
        timestamp = DateTime.UtcNow,
        documentation = "/swagger",
        health = "/health",
        services = new
        {
            catalog = new { prefix = "/catalog", port = 7295 },
            visualization = new { prefix = "/visualization", port = 7130 },
            promptgen = new { prefix = "/promptgen", port = 8000 },
            reading = new { prefix = "/reading", port = 7295 },
            auth = new { prefix = "/auth", port = 7295 }
        }
    }));

    // Error endpoint
    app.MapGet("/error", () => Results.Problem(
        title: "An error occurred",
        statusCode: StatusCodes.Status500InternalServerError));

    // Services status endpoint
    app.MapGet("/services", () => Results.Ok(new
    {
        gateway = new
        {
            name = "NovelVision.Gateway",
            status = "healthy",
            endpoints = new[] { "http://localhost:5000", "https://localhost:7000" }
        },
        downstream = new[]
        {
            new
            {
                name = "Catalog.API",
                description = "Book and Author management",
                prefix = "/catalog",
                endpoints = new[] { "http://localhost:5231", "https://localhost:7295" },
                routes = new[] { "/books", "/authors", "/chapters", "/pages", "/gutenberg" }
            },
            new
            {
                name = "Visualization.API",
                description = "AI Image Generation",
                prefix = "/visualization",
                endpoints = new[] { "http://localhost:5284", "https://localhost:7130" },
                routes = new[] { "/jobs", "/generate", "/queue", "/providers" }
            },
            new
            {
                name = "PromptGen.API",
                description = "AI Prompt Enhancement (Python/FastAPI)",
                prefix = "/promptgen",
                endpoints = new[] { "http://localhost:8000" },
                routes = new[] { "/prompts", "/visualization", "/styles", "/characters" }
            },
            new
            {
                name = "Reading",
                description = "Public reading endpoints",
                prefix = "/reading",
                endpoints = new[] { "https://localhost:7295" },
                routes = new[] { "/books/{id}", "/books/{id}/chapters/{n}", "/books/{id}/visualization-points" }
            },
            new
            {
                name = "Auth",
                description = "Authentication & Authorization",
                prefix = "/auth",
                endpoints = new[] { "https://localhost:7295" },
                routes = new[] { "/login", "/register", "/refresh", "/profile" }
            }
        }
    }));
}